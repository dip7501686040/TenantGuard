// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// TENANT & ORGANIZATION MODELS
// ================================

model Tenant {
  id       String       @id @default(uuid())
  slug     String       @unique // tenant-slug for subdomain routing
  name     String
  domain   String? // custom domain if any
  status   TenantStatus @default(ACTIVE)
  settings Json? // tenant-specific settings

  // Billing & Subscription
  plan     String @default("free")
  maxUsers Int    @default(10)
  maxOrgs  Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizations     Organization[]
  users             User[]
  identityProviders IdentityProvider[]
  auditLogs         AuditLog[]

  @@map("tenants")
}

model Organization {
  id          String  @id @default(uuid())
  tenantId    String
  name        String
  description String?

  // AWS-like organization settings
  masterAccountId String?
  billingEmail    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accounts Account[]
  roles    Role[]
  policies Policy[]

  @@map("organizations")
}

model Account {
  id             String      @id @default(uuid())
  organizationId String
  tenantId       String // for easy tenant isolation
  name           String
  accountType    AccountType @default(DEVELOPMENT)
  email          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAccounts    UserAccount[]
  roleAssignments RoleAssignment[]

  @@map("accounts")
}

// ================================
// USER & IDENTITY MODELS
// ================================

model User {
  id       String  @id @default(uuid())
  tenantId String
  email    String
  username String?

  // Native authentication
  passwordHash           String?
  isEmailVerified        Boolean @default(false)
  emailVerificationToken String?

  // Profile
  firstName String?
  lastName  String?
  avatar    String?
  timezone  String?
  locale    String? @default("en")

  // Security
  mfaEnabled   Boolean   @default(false)
  mfaSecret    String?
  tempMfaSetup String? // Temporary storage for MFA setup (fallback when Redis unavailable)
  backupCodes  String[]
  lastLoginAt  DateTime?
  loginCount   Int       @default(0)

  // Status
  status       UserStatus @default(ACTIVE)
  isBreakGlass Boolean    @default(false) // break-glass admin access

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userAccounts        UserAccount[]
  roleAssignments     RoleAssignment[]
  sessions            Session[]
  auditLogs           AuditLog[]
  federatedIdentities FederatedIdentity[]

  @@unique([tenantId, email])
  @@map("users")
}

model FederatedIdentity {
  id         String @id @default(uuid())
  userId     String
  tenantId   String
  providerId String // references IdentityProvider.id

  // IdP-specific data
  providerUserId String // user ID in the external IdP
  claims         Json // SAML/OIDC claims

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider IdentityProvider @relation(fields: [providerId], references: [id])

  @@unique([providerId, providerUserId])
  @@map("federated_identities")
}

model UserAccount {
  id        String @id @default(uuid())
  userId    String
  accountId String
  tenantId  String // for easy tenant isolation

  // Account-specific user settings
  isOwner  Boolean  @default(false)
  joinedAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([userId, accountId])
  @@map("user_accounts")
}

// ================================
// IDENTITY PROVIDER MODELS
// ================================

model IdentityProvider {
  id       String  @id @default(uuid())
  tenantId String
  name     String
  type     IdpType

  // SAML Configuration
  entityId    String? // SAML Entity ID
  ssoUrl      String? // SAML SSO URL
  certificate String? // X.509 certificate

  // OIDC Configuration
  issuer       String? // OIDC Issuer
  clientId     String? // OIDC Client ID
  clientSecret String? // OIDC Client Secret (encrypted)

  // Common Configuration
  domain         String? // verified domain for this IdP
  domainVerified Boolean @default(false)

  // SCIM Configuration
  scimEnabled  Boolean @default(false)
  scimEndpoint String?
  scimToken    String? // encrypted

  // Settings
  jitProvisioning Boolean   @default(true) // Just-in-time user creation
  status          IdpStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  federatedIdentities FederatedIdentity[]

  @@unique([tenantId, entityId]) // prevent duplicate SAML Entity IDs per tenant
  @@unique([tenantId, issuer]) // prevent duplicate OIDC Issuers per tenant
  @@map("identity_providers")
}

// ================================
// AUTHORIZATION MODELS (RBAC)
// ================================

model Role {
  id             String  @id @default(uuid())
  organizationId String? // org-level role if set
  tenantId       String // for easy tenant isolation
  name           String
  description    String?

  // Role metadata
  isSystemRole Boolean  @default(false) // system-defined roles
  permissions  String[] // array of permission strings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roleAssignments RoleAssignment[]

  @@unique([tenantId, organizationId, name])
  @@map("roles")
}

model RoleAssignment {
  id        String  @id @default(uuid())
  userId    String
  roleId    String
  accountId String? // account-specific assignment
  tenantId  String // for easy tenant isolation

  // Assignment metadata
  assignedBy String? // user ID who assigned this role
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, accountId])
  @@map("role_assignments")
}

model Policy {
  id             String  @id @default(uuid())
  organizationId String? // org-level policy if set
  tenantId       String // for easy tenant isolation
  name           String
  description    String?

  // Policy definition (ABAC-ready)
  effect     PolicyEffect @default(ALLOW)
  actions    String[] // array of actions
  resources  String[] // array of resource patterns
  conditions Json? // conditions for ABAC

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("policies")
}

// ================================
// SESSION & AUDIT MODELS
// ================================

model Session {
  id       String @id @default(uuid())
  userId   String
  tenantId String // for easy tenant isolation

  // Session data
  refreshToken String  @unique
  accessToken  String?
  ipAddress    String?
  userAgent    String?

  // Session metadata
  isActive  Boolean  @default(true)
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model AuditLog {
  id       String  @id @default(uuid())
  tenantId String
  userId   String? // nullable for system events

  // Event details
  action   String // login, logout, role_assigned, etc.
  resource String? // resource that was acted upon
  details  Json? // additional event details

  // Request context
  ipAddress String?
  userAgent String?

  // Result
  success      Boolean
  errorMessage String?

  timestamp DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// ================================
// ENUMS
// ================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum AccountType {
  PRODUCTION
  STAGING
  DEVELOPMENT
  SANDBOX
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum IdpType {
  SAML
  OIDC
  OAUTH2
}

enum IdpStatus {
  ACTIVE
  INACTIVE
  PENDING_VERIFICATION
}

enum PolicyEffect {
  ALLOW
  DENY
}
